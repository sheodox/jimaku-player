// ==UserScript==
// @name         VRV Subtitler
// @namespace    http://tampermonkey.net/
// @version      0.1.13
// @description  Display SRT format subtitles on VRV
// @author       sheodox
// @match        https://static.vrv.co/vilos/player.html
// @grant        GM_getValue
// @grant        GM_setValue
// ==/UserScript==

!function(t){var e={};function n(s){if(e[s])return e[s].exports;var o=e[s]={i:s,l:!1,exports:{}};return t[s].call(o.exports,o,o.exports,n),o.l=!0,o.exports}n.m=t,n.c=e,n.d=function(t,e,s){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:s})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var s=Object.create(null);if(n.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(s,o,function(e){return t[e]}.bind(null,o));return s},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=2)}([function(t,e){t.exports=class{constructor(t,e){this.format=t,this.fileName=e,this.subs=[]}getSubs(t){return this.subs.filter(e=>e.start<=t&&e.end>=t)}timeToMs(t){const[e,n,s]=t.split(":");return 36e5*+e+6e4*+n+1e3*parseFloat(s)}firstSubtitle(){return this.subs.reduce((t,e)=>e.start<t.start?e:t,{start:1/0})}}},function(t,e,n){const s=n(0),o=t=>(t.charAt(0).toLowerCase()+t.substring(1)).replace(" ",""),l=t=>{if(t){t=(t=t.replace(/[&H]/g,"")).padStart(8,"0");const[e,n,s,o,l]=t.match(/([0-9A-F]{2})([0-9A-F]{2})([0-9A-F]{2})([0-9A-F]{2})/i),r=t=>parseInt(t,16);return`rgba(${r(l)}, ${r(o)}, ${r(s)}, ${255-r(n)})`}},r=(t,e,n="transparent",s=0)=>{const o=t||n,l=`${void 0===e?1:e}px`;return`text-shadow: ${o} ${l} ${l}, ${o} ${l} -${l}, ${o} -${l} ${l}, ${o} -${l} -${l}, ${o} ${l} 0, ${o} 0 ${l}, ${o} -${l} 0, ${o} 0 -${l}, ${s}px ${s}px ${n}`};function i(t,e,n=!1){const s=new RegExp(n?`\\\\${e}\\((.*?)\\)`:`\\\\${e}([^\\\\}]*)`),o=t.match(s);if(o)return{overrides:t.replace(o[0],""),params:n?o[1].split(","):o[1]}}t.exports=class extends s{constructor(t,e){super("ass",e),t=t.replace(/\r\n/g,"\n");try{this.blocks=this.parseBlocks(t),this.subs=this.parseBlock(this.blocks.subs),this.parseInfo(this.blocks.info),this.parseSubTimings(),this.parseStyles(this.parseBlock(this.blocks.styles)),this.parseSubOverrideTags()}catch(t){console.error("ASS PARSE ERROR",t),this.subs=[]}}serialize(){return JSON.stringify({info:this.info,styles:this.styles,subs:this.subs},null,4)}debugInfo(){return[{title:"Number of styles",detail:Object.keys(this.styles).length},{title:"Number of subtitles",detail:this.subs.length}]}parseInfo(){this.info={},this.blocks.info.split("\n").forEach(t=>{const[e,n]=t.split(": ");this.info[o(e)]=n})}parseBlocks(t){const e=t.split(/\n(?=\[)/),n=t=>e.find(e=>{e=e.trim();const[n,s]=e.match(/^\[(.*?)]/);return s===t}).replace(/.*\n/,"").trim();return{info:n("Script Info"),styles:n("V4+ Styles"),subs:n("Events")}}parseBlock(t){const[e,...n]=t.split("\n"),s=(t,e=1/0)=>{let[n,s,o]=t.match(/(\w*): (.*)/);return o=o.split(","),o.length>e&&(o[e-1]=o.slice(e-1).join(","),o.splice(e,1/0)),{type:s,attributes:o}},l=s(e);return n.reduce((t,e)=>{if(!e||";"===e.charAt(0)||0===e.indexOf("Comment: "))return t;const n=s(e,l.attributes.length),r={dataType:n.type.toLowerCase()};return l.attributes.forEach((t,e)=>{t=t.trim();const s=o(t);r[s]=n.attributes[e]}),r.style="*Default"===r.style?"Default":r.style,t.push(r),t},[])}parseSubTimings(){this.subs.forEach(t=>{t.start=this.timeToMs(t.start),t.end=this.timeToMs(t.end)})}parseStyles(t){const e={};t.forEach(t=>{for(const e of Object.keys(t).filter(t=>/colour/i.test(t)))t[e]=l(t[e]);t.name="*Default"===t.name?"Default":t.name;const n=[],{primaryColour:s,secondaryColour:o,outlineColour:i,backColour:a,borderStyle:c,outline:u,shadow:d,fontname:f,fontsize:p,bold:m,italic:h,underline:g,strikeOut:y}=t;s&&n.push(`color: ${s}`),f&&n.push(`font-family: "${f}"`),p&&n.push(`font-size: ${p}pt`),"1"===c?n.push(r(i,u,a,d)):"3"===c&&n.push(`background-color: ${a}`),"-1"===m&&n.push("font-weight: bold"),"-1"===h&&n.push("font-style: italic"),"-1"!==g&&"-1"!==y||n.push(`text-decoration: ${"-1"===g?"underline":""} ${"-1"===y?"line-through":""}`),e[t.name]={inline:n.join(";"),raw:t}}),this.styles=e}parseSubOverrideTags(){this.subs.forEach(t=>{if(t.rawText=t.text,t.text=t.text.replace("\\N","\n"),!/{.+?}/.test(t.text))return;const e=t=>t.replace(/{.*?}/g,"");t.styledText=[];const n=function*(t){const e=/({.*?}[^{]*)/g;let n;for(;null!==(n=e.exec(t));)yield n[1]}(t.text);let s=[];for(const a of n){const n=[],c={text:e(a),fadeIn:0,fadeOut:0,inline:""};let u,d,f,p,[m]=a.match(/{.*?}/);function o(t,e=!1,n=(()=>{})){const s=i(m,t,e);s&&(n(s.params),m=s.overrides)}if(o("fscx"),o("fscy"),o("blur"),o("pos",!0,([t,e])=>{t=+t/+this.info.playResX*100,e=+e/+this.info.playResY*100,n.push(`position: fixed; left: ${t}vw; top: ${e}vh`)}),o("fad",!0,([e,n])=>{c.fadeIn=e,c.fadeOut=n,t.end-=n}),o("fsp",!1,t=>{s.push(`letter-spacing: ${t}px`)}),o("fs",!1,t=>{s.push(`font-size: ${t}pt`)}),o("u",!1,t=>{s.push(`text-decoration: ${t?"underline":"none"}`)}),o("s",!1,t=>{s.push(`text-decoration: ${t?"line-through":"none"}`)}),o("b",!1,t=>{s.push(`font-weight: ${t?"bold":"normal"}`)}),o("i",!1,t=>{s.push(`font-style: ${t?"italic":"normal"}`)}),o("fn",!1,t=>{s.push(`font-family: "${t}"`)}),o("1c",!1,t=>{s.push(`color: ${l(t)}`)}),o("3c",!1,t=>{u=t}),o("4c",!1,t=>{d=t}),o("bord",!1,t=>{f=t}),o("shad",!1,t=>{p=t}),[u,d,f,p].some(t=>void 0!==t)){const e=this.styles[t.style],n=(t,n)=>void 0!==t?t:e.raw[n];e&&(u=n(l(u),"outlineColour"),d=n(l(d),"backColour"),f=n(f,"outline"),p=n(p,"shadow"),s.push(r(u,f,d,p)))}o("r",!1,t=>{s=t?[this.styles[t].inline]:[]}),c.inline=s.join(";"),t.styledText.push(c),n.length&&(t.inline=n.join(";"))}t.text=e(t.text)})}}},function(t,e,n){"use strict";function s(){}n.r(e);const o=t=>t;function l(t){return t()}function r(){return Object.create(null)}function i(t){t.forEach(l)}function a(t){return"function"==typeof t}function c(t,e){return t!=t?e==e:t!==e||t&&"object"==typeof t||"function"==typeof t}const u="undefined"!=typeof window;let d=u?()=>window.performance.now():()=>Date.now(),f=u?t=>requestAnimationFrame(t):s;const p=new Set;function m(t){p.forEach(e=>{e.c(t)||(p.delete(e),e.f())}),0!==p.size&&f(m)}function h(t){let e;return 0===p.size&&f(m),{promise:new Promise(n=>{p.add(e={c:t,f:n})}),abort(){p.delete(e)}}}function g(t,e){t.appendChild(e)}function y(t,e,n){t.insertBefore(e,n||null)}function b(t){t.parentNode.removeChild(t)}function v(t,e){for(let n=0;n<t.length;n+=1)t[n]&&t[n].d(e)}function $(t){return document.createElement(t)}function x(t){return document.createTextNode(t)}function w(){return x(" ")}function k(){return x("")}function S(t,e,n,s){return t.addEventListener(e,n,s),()=>t.removeEventListener(e,n,s)}function C(t,e,n){null==n?t.removeAttribute(e):t.getAttribute(e)!==n&&t.setAttribute(e,n)}function E(t,e){e=""+e,t.data!==e&&(t.data=e)}function _(t,e){const n=document.createEvent("CustomEvent");return n.initCustomEvent(t,!1,!1,e),n}let j,O,T=0,q={};function I(t,e,n,s,o,l,r,i=0){const a=16.666/s;let c="{\n";for(let t=0;t<=1;t+=a){const s=e+(n-e)*l(t);c+=100*t+`%{${r(s,1-s)}}\n`}const u=c+`100% {${r(n,1-n)}}\n}`,d=`__svelte_${function(t){let e=5381,n=t.length;for(;n--;)e=(e<<5)-e^t.charCodeAt(n);return e>>>0}(u)}_${i}`;if(!q[d]){if(!j){const t=$("style");document.head.appendChild(t),j=t.sheet}q[d]=!0,j.insertRule(`@keyframes ${d} ${u}`,j.cssRules.length)}const f=t.style.animation||"";return t.style.animation=`${f?`${f}, `:""}${d} ${s}ms linear ${o}ms 1 both`,T+=1,d}function R(t,e){t.style.animation=(t.style.animation||"").split(", ").filter(e?t=>t.indexOf(e)<0:t=>-1===t.indexOf("__svelte")).join(", "),e&&!--T&&f(()=>{if(T)return;let t=j.cssRules.length;for(;t--;)j.deleteRule(t);q={}})}function P(t){O=t}function A(){if(!O)throw new Error("Function called outside component initialization");return O}function M(){const t=A();return(e,n)=>{const s=t.$$.callbacks[e];if(s){const o=_(e,n);s.slice().forEach(e=>{e.call(t,o)})}}}const N=[],z=[],B=[],F=[],L=Promise.resolve();let D=!1;function V(){D||(D=!0,L.then(G))}function U(t){B.push(t)}let J=!1;const H=new Set;function G(){if(!J){J=!0;do{for(let t=0;t<N.length;t+=1){const e=N[t];P(e),Y(e.$$)}for(N.length=0;z.length;)z.pop()();for(let t=0;t<B.length;t+=1){const e=B[t];H.has(e)||(H.add(e),e())}B.length=0}while(N.length);for(;F.length;)F.pop()();D=!1,J=!1,H.clear()}}function Y(t){if(null!==t.fragment){t.update(),i(t.before_update);const e=t.dirty;t.dirty=[-1],t.fragment&&t.fragment.p(t.ctx,e),t.after_update.forEach(U)}}let X;function Z(){return X||(X=Promise.resolve(),X.then(()=>{X=null})),X}function K(t,e,n){t.dispatchEvent(_(`${e?"intro":"outro"}${n}`))}const Q=new Set;let W;function tt(){W={r:0,c:[],p:W}}function et(){W.r||i(W.c),W=W.p}function nt(t,e){t&&t.i&&(Q.delete(t),t.i(e))}function st(t,e,n,s){if(t&&t.o){if(Q.has(t))return;Q.add(t),W.c.push(()=>{Q.delete(t),s&&(n&&t.d(1),s())}),t.o(e)}}const ot={duration:0};function lt(t,e,n){let l,r,i=e(t,n),c=!1,u=0;function f(){l&&R(t,l)}function p(){const{delay:e=0,duration:n=300,easing:a=o,tick:p=s,css:m}=i||ot;m&&(l=I(t,0,1,n,e,a,m,u++)),p(0,1);const g=d()+e,y=g+n;r&&r.abort(),c=!0,U(()=>K(t,!0,"start")),r=h(e=>{if(c){if(e>=y)return p(1,0),K(t,!0,"end"),f(),c=!1;if(e>=g){const t=a((e-g)/n);p(t,1-t)}}return c})}let m=!1;return{start(){m||(R(t),a(i)?(i=i(),Z().then(p)):p())},invalidate(){m=!1},end(){c&&(f(),c=!1)}}}function rt(t,e,n){let l,r=e(t,n),c=!0;const u=W;function f(){const{delay:e=0,duration:n=300,easing:a=o,tick:f=s,css:p}=r||ot;p&&(l=I(t,1,0,n,e,a,p));const m=d()+e,g=m+n;U(()=>K(t,!1,"start")),h(e=>{if(c){if(e>=g)return f(0,1),K(t,!1,"end"),--u.r||i(u.c),!1;if(e>=m){const t=a((e-m)/n);f(1-t,t)}}return c})}return u.r+=1,a(r)?Z().then(()=>{r=r(),f()}):f(),{end(e){e&&r.tick&&r.tick(1,0),c&&(l&&R(t,l),c=!1)}}}const it="undefined"!=typeof window?window:global;function at(t,e){st(t,1,1,()=>{e.delete(t.key)})}new Set(["allowfullscreen","allowpaymentrequest","async","autofocus","autoplay","checked","controls","default","defer","disabled","formnovalidate","hidden","ismap","loop","multiple","muted","nomodule","novalidate","open","playsinline","readonly","required","reversed","selected"]);let ct;function ut(t){t&&t.c()}function dt(t,e,n){const{fragment:s,on_mount:o,on_destroy:r,after_update:c}=t.$$;s&&s.m(e,n),U(()=>{const e=o.map(l).filter(a);r?r.push(...e):i(e),t.$$.on_mount=[]}),c.forEach(U)}function ft(t,e){const n=t.$$;null!==n.fragment&&(i(n.on_destroy),n.fragment&&n.fragment.d(e),n.on_destroy=n.fragment=null,n.ctx=[])}function pt(t,e,n,o,l,a,c=[-1]){const u=O;P(t);const d=e.props||{},f=t.$$={fragment:null,ctx:null,props:a,update:s,not_equal:l,bound:r(),on_mount:[],on_destroy:[],before_update:[],after_update:[],context:new Map(u?u.$$.context:[]),callbacks:r(),dirty:c};let p=!1;var m;f.ctx=n?n(t,d,(e,n,...s)=>{const o=s.length?s[0]:n;return f.ctx&&l(f.ctx[e],f.ctx[e]=o)&&(f.bound[e]&&f.bound[e](o),p&&function(t,e){-1===t.$$.dirty[0]&&(N.push(t),V(),t.$$.dirty.fill(0)),t.$$.dirty[e/31|0]|=1<<e%31}(t,e)),n}):[],f.update(),p=!0,i(f.before_update),f.fragment=!!o&&o(f.ctx),e.target&&(e.hydrate?f.fragment&&f.fragment.l((m=e.target,Array.from(m.childNodes))):f.fragment&&f.fragment.c(),e.intro&&nt(t.$$.fragment),dt(t,e.target,e.anchor),G()),P(u)}"function"==typeof HTMLElement&&(ct=class extends HTMLElement{constructor(){super(),this.attachShadow({mode:"open"})}connectedCallback(){for(const t in this.$$.slotted)this.appendChild(this.$$.slotted[t])}attributeChangedCallback(t,e,n){this[t]=n}$destroy(){ft(this,1),this.$destroy=s}$on(t,e){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(){}});class mt{$destroy(){ft(this,1),this.$destroy=s}$on(t,e){const n=this.$$.callbacks[t]||(this.$$.callbacks[t]=[]);return n.push(e),()=>{const t=n.indexOf(e);-1!==t&&n.splice(t,1)}}$set(){}}function ht(t){const e=t-1;return e*e*e+1}function gt(t,{delay:e=0,duration:n=400,easing:s=o}){const l=+getComputedStyle(t).opacity;return{delay:e,duration:n,easing:s,css:t=>`opacity: ${t*l}`}}function yt(t,{delay:e=0,duration:n=400,easing:s=ht,x:o=0,y:l=0,opacity:r=0}){const i=getComputedStyle(t),a=+i.opacity,c="none"===i.transform?"":i.transform,u=a*(1-r);return{delay:e,duration:n,easing:s,css:(t,e)=>`\n\t\t\ttransform: ${c} translate(${(1-t)*o}px, ${(1-t)*l}px);\n\t\t\topacity: ${a-u*e}`}}function bt(t,e,n){const s=t.slice();return s[21]=e[n],s}function vt(t,e,n){const s=t.slice();return s[18]=e[n],s}function $t(t){let e,n,o,l,r,i,a,c,u,d,f,p,m,h,k,S=t[1].fileName+"",_=t[2]>0?"+":"",j=(t[2]/1e3).toFixed(1)+"",O=t[1].debugInfo(),T=[];for(let e=0;e<O.length;e+=1)T[e]=kt(bt(t,O,e));return{c(){e=$("h2"),e.textContent="Debug Information",n=w(),o=$("dl"),l=$("dt"),l.textContent="Subtitles File",r=$("dd"),i=x(S),a=$("dt"),a.textContent="Alignment",c=$("dd"),u=x(_),d=x(j),f=x(" seconds");for(let t=0;t<T.length;t+=1)T[t].c();p=w(),m=$("a"),h=x("â¬‡ Download Parsed Subtitles"),C(e,"class","svelte-mdg8y7"),C(l,"class","svelte-mdg8y7"),C(r,"class","svelte-mdg8y7"),C(a,"class","svelte-mdg8y7"),C(c,"class","svelte-mdg8y7"),C(o,"class","svelte-mdg8y7"),C(m,"href",k=t[6]()),C(m,"download","parsed-subtitles.json"),C(m,"class","svelte-mdg8y7")},m(t,s){y(t,e,s),y(t,n,s),y(t,o,s),g(o,l),g(o,r),g(r,i),g(o,a),g(o,c),g(c,u),g(c,d),g(c,f);for(let t=0;t<T.length;t+=1)T[t].m(o,null);y(t,p,s),y(t,m,s),g(m,h)},p(t,e){if(2&e&&S!==(S=t[1].fileName+"")&&E(i,S),4&e&&_!==(_=t[2]>0?"+":"")&&E(u,_),4&e&&j!==(j=(t[2]/1e3).toFixed(1)+"")&&E(d,j),2&e){let n;for(O=t[1].debugInfo(),n=0;n<O.length;n+=1){const s=bt(t,O,n);T[n]?T[n].p(s,e):(T[n]=kt(s),T[n].c(),T[n].m(o,null))}for(;n<T.length;n+=1)T[n].d(1);T.length=O.length}},i:s,o:s,d(t){t&&b(e),t&&b(n),t&&b(o),v(T,t),t&&b(p),t&&b(m)}}}function xt(t){let e,n,o,l,r,a,c,u,d,f,p,m,h,g,v,x,k,E;return{c(){e=$("h2"),e.textContent="Settings",n=w(),o=$("button"),o.textContent="Reselect subtitles",l=w(),r=$("button"),r.textContent="Realign subtitles",a=w(),c=$("br"),u=w(),d=$("input"),f=w(),p=$("label"),p.textContent="Show subs over video",m=w(),h=$("br"),g=w(),v=$("input"),x=w(),k=$("label"),k.textContent="Pause when tray is open",C(e,"class","svelte-mdg8y7"),C(o,"class","svelte-mdg8y7"),C(r,"class","svelte-mdg8y7"),C(c,"class","svelte-mdg8y7"),C(d,"id","show-subs"),C(d,"type","checkbox"),d.checked=!0,C(d,"class","svelte-mdg8y7"),C(p,"for","show-subs"),C(p,"class","svelte-mdg8y7"),C(h,"class","svelte-mdg8y7"),C(v,"id","pause-on-tray"),C(v,"type","checkbox"),C(v,"class","svelte-mdg8y7"),C(k,"for","pause-on-tray"),C(k,"class","svelte-mdg8y7")},m(s,i){y(s,e,i),y(s,n,i),y(s,o,i),y(s,l,i),y(s,r,i),y(s,a,i),y(s,c,i),y(s,u,i),y(s,d,i),y(s,f,i),y(s,p,i),y(s,m,i),y(s,h,i),y(s,g,i),y(s,v,i),v.checked=t[4],y(s,x,i),y(s,k,i),E=[S(o,"click",t[15]),S(r,"click",t[16]),S(d,"change",t[8]("show-subs")),S(v,"change",t[17])]},p(t,e){16&e&&(v.checked=t[4])},i:s,o:s,d(t){t&&b(e),t&&b(n),t&&b(o),t&&b(l),t&&b(r),t&&b(a),t&&b(c),t&&b(u),t&&b(d),t&&b(f),t&&b(p),t&&b(m),t&&b(h),t&&b(g),t&&b(v),t&&b(x),t&&b(k),i(E)}}}function wt(t){let e,n,s,o,l=[],r=new Map,i=t[0];const a=t=>t[18].text;for(let e=0;e<i.length;e+=1){let n=vt(t,i,e),s=a(n);r.set(s,l[e]=St(s,n))}return{c(){e=$("h2"),e.textContent="Recent Subtitles",n=w(),s=$("ul");for(let t=0;t<l.length;t+=1)l[t].c();C(e,"class","svelte-mdg8y7"),C(s,"class","recent-subs svelte-mdg8y7")},m(t,r){y(t,e,r),y(t,n,r),y(t,s,r);for(let t=0;t<l.length;t+=1)l[t].m(s,null);o=!0},p(t,e){if(33&e){const n=t[0];tt(),l=function(t,e,n,s,o,l,r,i,a,c,u,d){let f=t.length,p=l.length,m=f;const h={};for(;m--;)h[t[m].key]=m;const g=[],y=new Map,b=new Map;for(m=p;m--;){const t=d(o,l,m),i=n(t);let a=r.get(i);a?s&&a.p(t,e):(a=c(i,t),a.c()),y.set(i,g[m]=a),i in h&&b.set(i,Math.abs(m-h[i]))}const v=new Set,$=new Set;function x(t){nt(t,1),t.m(i,u),r.set(t.key,t),u=t.first,p--}for(;f&&p;){const e=g[p-1],n=t[f-1],s=e.key,o=n.key;e===n?(u=e.first,f--,p--):y.has(o)?!r.has(s)||v.has(s)?x(e):$.has(o)?f--:b.get(s)>b.get(o)?($.add(s),x(e)):(v.add(o),f--):(a(n,r),f--)}for(;f--;){const e=t[f];y.has(e.key)||a(e,r)}for(;p;)x(g[p-1]);return g}(l,e,a,1,t,n,r,s,at,St,null,vt),et()}},i(t){if(!o){for(let t=0;t<i.length;t+=1)nt(l[t]);o=!0}},o(t){for(let t=0;t<l.length;t+=1)st(l[t]);o=!1},d(t){t&&b(e),t&&b(n),t&&b(s);for(let t=0;t<l.length;t+=1)l[t].d()}}}function kt(t){let e,n,s,o,l=t[21].title+"",r=t[21].detail+"";return{c(){e=$("dt"),n=x(l),s=$("dd"),o=x(r),C(e,"class","svelte-mdg8y7"),C(s,"class","svelte-mdg8y7")},m(t,l){y(t,e,l),g(e,n),y(t,s,l),g(s,o)},p(t,e){2&e&&l!==(l=t[21].title+"")&&E(n,l),2&e&&r!==(r=t[21].detail+"")&&E(o,r)},d(t){t&&b(e),t&&b(s)}}}function St(t,e){let n,s,o,l,r,i,a,c,u,d=e[18].text+"";return{key:t,first:null,c(){n=$("li"),s=$("a"),o=x(d),r=w(),C(s,"target","_blank"),C(s,"href",l=`https://jisho.org/search/${encodeURIComponent(e[18].text.trim())}`),C(s,"rel","noopener noreferrer"),C(s,"class","svelte-mdg8y7"),C(n,"class","svelte-mdg8y7"),this.first=n},m(t,l){y(t,n,l),g(n,s),g(s,o),g(n,r),c=!0,u=S(s,"click",e[14])},p(t,e){(!c||1&e)&&d!==(d=t[18].text+"")&&E(o,d),(!c||1&e&&l!==(l=`https://jisho.org/search/${encodeURIComponent(t[18].text.trim())}`))&&C(s,"href",l)},i(t){c||(U(()=>{a&&a.end(1),i||(i=lt(n,yt,{y:50,duration:200})),i.start()}),c=!0)},o(t){i&&i.invalidate(),a=rt(n,yt,{y:-50,duration:200}),c=!1},d(t){t&&b(n),t&&a&&a.end(),u()}}}function Ct(t){let e,n,s,o,l,r,a,c,u,d,f,p,m,h,v,k,E,_,j,O,T,q;const I=[wt,xt,$t],R=[];function P(t,e){return"recent"===t[3]?0:"settings"===t[3]?1:"debug"===t[3]?2:-1}return~(j=P(t))&&(O=R[j]=I[j](t)),{c(){e=$("div"),n=$("h1"),n.textContent="VRV Subtitler",s=w(),o=$("div"),l=w(),r=$("div"),a=$("button"),c=x("Recent Subtitles"),d=w(),f=$("button"),p=x("Settings"),h=w(),v=$("button"),k=x("Debug"),_=w(),O&&O.c(),C(n,"class","svelte-mdg8y7"),C(o,"class","svelte-mdg8y7"),a.disabled=u="recent"===t[3],C(a,"class","svelte-mdg8y7"),f.disabled=m="settings"===t[3],C(f,"class","svelte-mdg8y7"),v.disabled=E="debug"===t[3],C(v,"class","svelte-mdg8y7"),C(r,"class","tray-tabs svelte-mdg8y7"),C(e,"class","tray svelte-mdg8y7")},m(i,u){y(i,e,u),g(e,n),g(e,s),g(e,o),g(e,l),g(e,r),g(r,a),g(a,c),g(r,d),g(r,f),g(f,p),g(r,h),g(r,v),g(v,k),g(e,_),~j&&R[j].m(e,null),T=!0,q=[S(a,"click",t[11]),S(f,"click",t[12]),S(v,"click",t[13]),S(e,"mouseenter",t[7](!0)),S(e,"mouseleave",t[7](!1))]},p(t,[n]){(!T||8&n&&u!==(u="recent"===t[3]))&&(a.disabled=u),(!T||8&n&&m!==(m="settings"===t[3]))&&(f.disabled=m),(!T||8&n&&E!==(E="debug"===t[3]))&&(v.disabled=E);let s=j;j=P(t),j===s?~j&&R[j].p(t,n):(O&&(tt(),st(R[s],1,1,()=>{R[s]=null}),et()),~j?(O=R[j],O||(O=R[j]=I[j](t),O.c()),nt(O,1),O.m(e,null)):O=null)},i(t){T||(nt(O),T=!0)},o(t){st(O),T=!1},d(t){t&&b(e),~j&&R[j].d(),i(q)}}}function Et(t,e,n){const s=M();let{recentSubs:o=[]}=e,{subtitles:l={}}=e,{alignment:r=0}=e,i="recent",a=!0;return t.$set=t=>{"recentSubs"in t&&n(0,o=t.recentSubs),"subtitles"in t&&n(1,l=t.subtitles),"alignment"in t&&n(2,r=t.alignment)},[o,l,r,i,a,s,function(){const t=new Blob([l.serialize()],{type:"application/json"});return URL.createObjectURL(t)},function(t){return()=>{t&&!a||s("tray-pauser",t)}},function(t){return e=>{s(t,e.target.checked)}},!1,!0,()=>n(3,i="recent"),()=>n(3,i="settings"),()=>n(3,i="debug"),()=>s("define-pauser"),()=>s("restart"),()=>s("realign"),function(){a=this.checked,n(4,a)}]}var _t=class extends mt{constructor(t){var e;super(),document.getElementById("svelte-mdg8y7-style")||((e=$("style")).id="svelte-mdg8y7-style",e.textContent=".tray.svelte-mdg8y7.svelte-mdg8y7{margin-top:0.5rem;width:2vw;background:rgba(255, 255, 255, 0.2);position:fixed;right:0;top:0;color:white;height:calc(100% - 5rem)}.tray.svelte-mdg8y7>.svelte-mdg8y7{visibility:hidden}.tray.svelte-mdg8y7.svelte-mdg8y7:hover{width:40vw;max-width:40rem;background:rgb(33, 39, 55);overflow:auto;border-radius:3px}.tray.svelte-mdg8y7:hover>.svelte-mdg8y7{visibility:visible}.tray.svelte-mdg8y7 h1.svelte-mdg8y7{font-size:2rem;background:rgb(27, 26, 38);padding:0.5rem 0;border-radius:3px;margin:0 0 0.5rem 0;border-bottom:2px solid #f47521}.tray.svelte-mdg8y7 h2.svelte-mdg8y7{margin:0;text-decoration:underline}button.svelte-mdg8y7.svelte-mdg8y7{margin:0.5rem}ul.svelte-mdg8y7.svelte-mdg8y7{list-style:none}a.svelte-mdg8y7.svelte-mdg8y7{color:white;transform:scaleY(0);transform-origin:top;transition:transform 0.5s ease;font-size:1rem;text-decoration:none}a.svelte-mdg8y7.svelte-mdg8y7:hover{color:#0aff8c;cursor:pointer;text-decoration:underline}li.svelte-mdg8y7.svelte-mdg8y7:not(:first-of-type)::before{content:' ';position:relative;background:#f47521;height:0.1rem;width:3.2rem;display:block;margin:0 auto;border-radius:4px}dl.svelte-mdg8y7.svelte-mdg8y7{padding:2rem;text-align:left}dt.svelte-mdg8y7.svelte-mdg8y7{font-weight:bold}dd.svelte-mdg8y7.svelte-mdg8y7{font-style:italic}",g(document.head,e)),pt(this,t,Et,Ct,c,{recentSubs:0,subtitles:1,alignment:2})}};function jt(t,e,n){const s=t.slice();return s[11]=e[n],s}function Ot(t,e,n){const s=t.slice();return s[8]=e[n],s}function Tt(t){let e,n,s=t[0],o=[];for(let e=0;e<s.length;e+=1)o[e]=Pt(Ot(t,s,e));const l=t=>st(o[t],1,1,()=>{o[t]=null});return{c(){for(let t=0;t<o.length;t+=1)o[t].c();e=k()},m(t,s){for(let e=0;e<o.length;e+=1)o[e].m(t,s);y(t,e,s),n=!0},p(t,n){if(13&n){let r;for(s=t[0],r=0;r<s.length;r+=1){const l=Ot(t,s,r);o[r]?(o[r].p(l,n),nt(o[r],1)):(o[r]=Pt(l),o[r].c(),nt(o[r],1),o[r].m(e.parentNode,e))}for(tt(),r=s.length;r<o.length;r+=1)l(r);et()}},i(t){if(!n){for(let t=0;t<s.length;t+=1)nt(o[t]);n=!0}},o(t){o=o.filter(Boolean);for(let t=0;t<o.length;t+=1)st(o[t]);n=!1},d(t){v(o,t),t&&b(e)}}}function qt(t){let e,n=t[8].text+"";return{c(){e=x(n)},m(t,n){y(t,e,n)},p(t,s){1&s&&n!==(n=t[8].text+"")&&E(e,n)},i:s,o:s,d(t){t&&b(e)}}}function It(t){let e,n,s=t[8].styledText,o=[];for(let e=0;e<s.length;e+=1)o[e]=Rt(jt(t,s,e));const l=t=>st(o[t],1,1,()=>{o[t]=null});return{c(){for(let t=0;t<o.length;t+=1)o[t].c();e=k()},m(t,s){for(let e=0;e<o.length;e+=1)o[e].m(t,s);y(t,e,s),n=!0},p(t,n){if(1&n){let r;for(s=t[8].styledText,r=0;r<s.length;r+=1){const l=jt(t,s,r);o[r]?(o[r].p(l,n),nt(o[r],1)):(o[r]=Rt(l),o[r].c(),nt(o[r],1),o[r].m(e.parentNode,e))}for(tt(),r=s.length;r<o.length;r+=1)l(r);et()}},i(t){if(!n){for(let t=0;t<s.length;t+=1)nt(o[t]);n=!0}},o(t){o=o.filter(Boolean);for(let t=0;t<o.length;t+=1)st(o[t]);n=!1},d(t){v(o,t),t&&b(e)}}}function Rt(t){let e,n,s,o,l,r,i=t[11].text+"";return{c(){e=$("span"),n=x(i),C(e,"style",s=t[11].inline)},m(t,s){y(t,e,s),g(e,n),r=!0},p(t,o){(!r||1&o)&&i!==(i=t[11].text+"")&&E(n,i),(!r||1&o&&s!==(s=t[11].inline))&&C(e,"style",s)},i(n){r||(U(()=>{l&&l.end(1),o||(o=lt(e,gt,t[11].fadeIn)),o.start()}),r=!0)},o(n){o&&o.invalidate(),l=rt(e,gt,t[11].fadeOut),r=!1},d(t){t&&b(e),t&&l&&l.end()}}}function Pt(t){let e,n,s,o,l,r,i,a;const c=[It,qt],u=[];function d(t,e){return t[8].styledText?0:1}function f(...e){return t[7](t[8],...e)}return n=d(t),s=u[n]=c[n](t),{c(){e=$("p"),s.c(),o=w(),C(e,"style",l=t[3](t[8])),C(e,"data-sub-style",r=t[8].style),C(e,"title","click to search this phrase on Jisho.org"),C(e,"class","svelte-1w98obp")},m(t,s){y(t,e,s),u[n].m(e,null),g(e,o),i=!0,a=S(e,"click",f)},p(a,f){let p=n;n=d(t=a),n===p?u[n].p(t,f):(tt(),st(u[p],1,1,()=>{u[p]=null}),et(),s=u[n],s||(s=u[n]=c[n](t),s.c()),nt(s,1),s.m(e,o)),(!i||1&f&&l!==(l=t[3](t[8])))&&C(e,"style",l),(!i||1&f&&r!==(r=t[8].style))&&C(e,"data-sub-style",r)},i(t){i||(nt(s),i=!0)},o(t){st(s),i=!1},d(t){t&&b(e),u[n].d(),a()}}}function At(t){let e,n,s=t[1]&&Tt(t);return{c(){e=$("div"),s&&s.c(),C(e,"class","subtitles")},m(t,o){y(t,e,o),s&&s.m(e,null),n=!0},p(t,[n]){t[1]?s?(s.p(t,n),nt(s,1)):(s=Tt(t),s.c(),nt(s,1),s.m(e,null)):s&&(tt(),st(s,1,1,()=>{s=null}),et())},i(t){n||(nt(s),n=!0)},o(t){st(s),n=!1},d(t){t&&b(e),s&&s.d()}}}function Mt(t,e,n){let{current:s=[]}=e,{styles:o={}}=e,{format:l=""}=e,{visible:r=!0}=e;const i=M();function a(t){i("define-pauser"),window.open(`https://jisho.org/search/${encodeURIComponent(t.trim())}`)}return t.$set=t=>{"current"in t&&n(0,s=t.current),"styles"in t&&n(4,o=t.styles),"format"in t&&n(5,l=t.format),"visible"in t&&n(1,r=t.visible)},[s,r,a,function(t){return"srt"===l?`font-size: ${1.5+1.5*(t.line?t.line:1)}rem; -webkit-text-stroke: 2px black;text-shadow: 3px 3px black;font-weight: bold`:"ass"===l&&t.style in o?[o[t.style].inline,t.inline||""].join(";"):void 0},o,l,i,t=>a(t.text)]}var Nt=class extends mt{constructor(t){var e;super(),document.getElementById("svelte-1w98obp-style")||((e=$("style")).id="svelte-1w98obp-style",e.textContent="p.svelte-1w98obp{cursor:pointer;color:white;margin:0;padding:0;white-space:pre}p.svelte-1w98obp:hover{color:#0aff8c !important}",g(document.head,e)),pt(this,t,Mt,At,c,{current:0,styles:4,format:5,visible:1})}};class zt{constructor(){this.video=null,this.reasons=[]}setVideo(t){this.reasons=[],this.video=t}addPauser(t){this.reasons.push(t),this._checkPause()}removePauser(t){const e=this.reasons.indexOf(t);-1!==e&&(this.reasons.splice(e,1),this._checkPause())}_checkPause(){this.reasons.length?this.video.pause():this.video.play()}}var Bt=n(1),Ft=n.n(Bt),Lt=n(0),Dt=n.n(Lt);class Vt extends Dt.a{constructor(t,e){super("srt",e);const n=t.split("\n\n");this.subs=n.reduce((t,e)=>{let n=e.trim().split("\n");function s(){n.shift()}try{/^\d*$/.test(n[0])&&s();let[e,o]=n[0].replace(/,/g,".").match(/^([\d:\.\-> ]*)/)[0].split(/\-\->/),l=n[0].match(/([a-zA-Z].*)/);l=l&&l.length?l[1]:"";const r=(t=>{const e=l.match(new RegExp(`${t}:([\\d\\.]*)%`));if(e)return parseInt(e[1],10)/100})("line")||1;s(),t.push({start:this.timeToMs(e),end:this.timeToMs(o),text:n.join("\n").replace(/<\/?c.Japanese>/g,""),line:r})}catch(t){}return t},[])}serialize(){return JSON.stringify(this.subs,null,4)}debugInfo(){return[{title:"Number of subtitles",detail:this.subs.length}]}}function Ut(t){let e,n,o,l;return{c(){e=$("label"),e.textContent="Select a subtitle file to begin",n=w(),o=$("input"),C(e,"for","srt-upload"),C(e,"class","svelte-7fhqwx"),C(o,"type","file"),C(o,"id","srt-upload"),C(o,"accept",".srt,.ass,.ssa"),C(o,"class","svelte-7fhqwx")},m(s,r){y(s,e,r),y(s,n,r),y(s,o,r),l=S(o,"change",t[0])},p:s,i:s,o:s,d(t){t&&b(e),t&&b(n),t&&b(o),l()}}}function Jt(t){const e=M();return[function(t){const n=t.target.files[0],s=new FileReader;s.onload=t=>{const s={ass:Ft.a,ssa:Ft.a,srt:Vt},[o,l]=n.name.match(/\.(\w{3})$/);e("subtitles-loaded",new s[l](t.target.result,n.name))},s.readAsText(n)}]}var Ht=class extends mt{constructor(t){var e;super(),document.getElementById("svelte-7fhqwx-style")||((e=$("style")).id="svelte-7fhqwx-style",e.textContent="label.svelte-7fhqwx{background:#fd0;border:none;cursor:pointer;padding:10px;line-height:1;font-weight:bold;color:black;text-transform:uppercase;display:inline-block;margin:2rem}label.svelte-7fhqwx:hover{background:#ffea6d}input.svelte-7fhqwx{display:none}",g(document.head,e)),pt(this,t,Jt,Ut,c,{})}};const{document:Gt}=it;function Yt(t){let e,n,o,l,r,a,c,u,d,f,p,m,h,v,k=t[0].text+"",_="number"==typeof t[1]&&function(t){let e,n;return{c(){e=$("button"),e.textContent=`\n\t\t\t\tUse the last alignment (${Math.abs(t[2])} seconds ${t[1]>0?"later":"earlier"}).\n\t\t\t`,C(e,"class","svelte-1lai4ts")},m(s,o){y(s,e,o),n=S(e,"click",t[3])},p:s,d(t){t&&b(e),n()}}}(t);return{c(){e=$("div"),n=$("button"),o=x("Click when the first line is said:\n\t\t"),l=$("br"),r=w(),a=$("pre"),c=x(k),u=w(),d=$("div"),_&&_.c(),f=w(),p=$("button"),p.textContent="No alignment adjustment.",m=w(),h=$("button"),h.textContent="Enter alignment manually.",C(n,"class","svelte-1lai4ts"),C(p,"class","svelte-1lai4ts"),C(h,"class","svelte-1lai4ts"),C(d,"class","row svelte-1lai4ts"),C(e,"class","alignment-buttons svelte-1lai4ts")},m(s,i){y(s,e,i),g(e,n),g(n,o),g(n,l),g(n,r),g(n,a),g(a,c),g(e,u),g(e,d),_&&_.m(d,null),g(d,f),g(d,p),g(d,m),g(d,h),v=[S(n,"click",t[5]),S(p,"click",t[8]),S(h,"click",t[4])]},p(t,[e]){1&e&&k!==(k=t[0].text+"")&&E(c,k),"number"==typeof t[1]&&_.p(t,e)},i:s,o:s,d(t){t&&b(e),_&&_.d(),i(v)}}}function Xt(t,e,n){let{firstSubtitle:s={}}=e;const o=M(),l=GM_getValue("last-used-alignment"),r=(l/1e3).toFixed(1);function i(t){const e=document.querySelector("video"),n="number"==typeof t?t:1e3*e.currentTime-s.start-400;GM_setValue("last-used-alignment",n),o("set-align",n)}return t.$set=t=>{"firstSubtitle"in t&&n(0,s=t.firstSubtitle)},[s,l,r,function(){i(l)},function(){const t=parseFloat(prompt("Enter an alignment in seconds. Positive numbers mean the subtitles are timed earlier than the video and need to be delayed.",r));isNaN(t)||i(1e3*t)},i,o,"last-used-alignment",()=>i(0)]}var Zt=class extends mt{constructor(t){var e;super(),Gt.getElementById("svelte-1lai4ts-style")||((e=$("style")).id="svelte-1lai4ts-style",e.textContent=".alignment-buttons.svelte-1lai4ts.svelte-1lai4ts{display:flex;flex-direction:column}.alignment-buttons.svelte-1lai4ts button.svelte-1lai4ts{margin:0.5rem;align-self:center}.row.svelte-1lai4ts.svelte-1lai4ts{display:flex;flex-direction:row;justify-content:center}",g(Gt.head,e)),pt(this,t,Xt,Yt,c,{firstSubtitle:0})}};const{document:Kt}=it;function Qt(t){let e,n;const s=new Nt({props:{format:t[2].format,styles:t[2].styles,current:t[1],currentTime:t[6],visible:t[5]}});s.$on("define-pauser",t[11]);const o=new _t({props:{recentSubs:t[4],subtitles:t[2],alignment:t[3]}});return o.$on("restart",t[7]),o.$on("tray-pauser",t[10]),o.$on("define-pauser",t[11]),o.$on("realign",t[17]),o.$on("show-subs",t[18]),{c(){ut(s.$$.fragment),e=w(),ut(o.$$.fragment)},m(t,l){dt(s,t,l),y(t,e,l),dt(o,t,l),n=!0},p(t,e){const n={};4&e&&(n.format=t[2].format),4&e&&(n.styles=t[2].styles),2&e&&(n.current=t[1]),32&e&&(n.visible=t[5]),s.$set(n);const l={};16&e&&(l.recentSubs=t[4]),4&e&&(l.subtitles=t[2]),8&e&&(l.alignment=t[3]),o.$set(l)},i(t){n||(nt(s.$$.fragment,t),nt(o.$$.fragment,t),n=!0)},o(t){st(s.$$.fragment,t),st(o.$$.fragment,t),n=!1},d(t){ft(s,t),t&&b(e),ft(o,t)}}}function Wt(t){let e;const n=new Zt({props:{firstSubtitle:t[2].firstSubtitle()}});return n.$on("set-align",t[8]),{c(){ut(n.$$.fragment)},m(t,s){dt(n,t,s),e=!0},p(t,e){const s={};4&e&&(s.firstSubtitle=t[2].firstSubtitle()),n.$set(s)},i(t){e||(nt(n.$$.fragment,t),e=!0)},o(t){st(n.$$.fragment,t),e=!1},d(t){ft(n,t)}}}function te(t){let e;const n=new Ht({});return n.$on("subtitles-loaded",t[9]),{c(){ut(n.$$.fragment)},m(t,s){dt(n,t,s),e=!0},p:s,i(t){e||(nt(n.$$.fragment,t),e=!0)},o(t){st(n.$$.fragment,t),e=!1},d(t){ft(n,t)}}}function ee(t){let e,n,s,o;const l=[te,Wt,Qt],r=[];function i(t,e){return"prompt"===t[0]?0:"align"===t[0]?1:"play"===t[0]?2:-1}return~(n=i(t))&&(s=r[n]=l[n](t)),{c(){e=$("div"),s&&s.c(),C(e,"class","subtitles-app svelte-qdgese")},m(t,s){y(t,e,s),~n&&r[n].m(e,null),o=!0},p(t,[o]){let a=n;n=i(t),n===a?~n&&r[n].p(t,o):(s&&(tt(),st(r[a],1,1,()=>{r[a]=null}),et()),~n?(s=r[n],s||(s=r[n]=l[n](t),s.c()),nt(s,1),s.m(e,null)):s=null)},i(t){o||(nt(s),o=!0)},o(t){st(s),o=!1},d(t){t&&b(e),~n&&r[n].d()}}}function ne(t,e,n){const s=new zt;let o="prompt",l=[],r=null,i=null,a=-1,c=[],u=!0;function d(){n(0,o="prompt"),n(2,r=null),n(1,l=[])}var f;function p(t){let e=t[t.length-1],s=c[c.length-1];!e||s&&e.text===s.text||n(4,c=[...c,e]),c.length>10&&n(4,c=c.slice(c.length-10))}function m(){"play"===o&&(n(1,l=r.getSubs(1e3*i.currentTime-a)),p(l),requestAnimationFrame(m))}f=()=>{document.addEventListener("visibilitychange",()=>{document.hidden||s.removePauser("define")});let t="";setInterval(()=>{const e=document.querySelector("video").getAttribute("src");e&&e!==t&&(t=e,d())},50)},A().$$.on_mount.push(f);return[o,l,r,a,c,u,"",d,function(t){i=document.querySelector("video"),s.setVideo(i),n(3,a=t.detail),n(4,c=[]),n(0,o="play"),m()},function(t){n(2,r=t.detail),0===r.subs.length?(console.log("subtitles object failed to parse: ",r),alert(`No subtitles were parsed from the selected .${r.format} file, verify nothing is wrong with the file. If it appears normal please submit a bug report with the episode and the subtitles file you used to the issue tracker!`)):n(0,o="align")},function(t){t.detail?s.addPauser("tray"):s.removePauser("tray")},function(){s.addPauser("define")},i,"last-used-alignment",s,p,m,()=>n(0,o="align"),t=>n(5,u=t.detail)]}var se=class extends mt{constructor(t){var e;super(),Kt.getElementById("svelte-qdgese-style")||((e=$("style")).id="svelte-qdgese-style",e.textContent=".subtitles-app.svelte-qdgese{position:relative}.subtitles-app.svelte-qdgese>*{z-index:1000000000}.subtitles-app.svelte-qdgese button{background:#fd0;border:none;cursor:pointer;padding:10px;line-height:1;font-weight:bold;color:black;text-transform:uppercase}.subtitles-app.svelte-qdgese button:disabled{background:#2a3450}.subtitles-app.svelte-qdgese button:not(:disabled):hover{background:#ffea6d}",g(Kt.head,e)),pt(this,t,ne,ee,c,{})}};const oe=document.createElement("div");document.body.appendChild(oe),oe.id="sheodox-vrv-subtitler",oe.style.height="100%",oe.style.width="100%";new se({target:oe})}]);
